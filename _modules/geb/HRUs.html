

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>geb.HRUs &mdash; GEB  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=5dd5ad26" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5be48651"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=27b9c81c"></script>
      <script src="../../_static/doctools.js?v=695de88e"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="copyright" title="Copyright" href="../../copyright.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            GEB
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../preprocessing.html">Preprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../running.html">Running the model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../visualisation.html">Visualisation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../calibration.html">Calibration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ODD/ODD.html">ODD protocol</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Agents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../agents/__init__.html">Agents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../agents/farmers.html">Farmers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../agents/government.html">Government</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../model.html">Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cwatm_model.html">CWatM Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../report.html">Report</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../HRUs.html">Farm-level HRUs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../artists.html">Artists</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">About</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../authors_page.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../updates.html">Updates</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">GEB</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">geb.HRUs</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for geb.HRUs</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numba</span><span class="w"> </span><span class="kn">import</span> <span class="n">njit</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">rasterio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">affine</span><span class="w"> </span><span class="kn">import</span> <span class="n">Affine</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">zarr</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">zarr.convenience</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">geb.workflows</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncForcingReader</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.spatial</span><span class="w"> </span><span class="kn">import</span> <span class="n">cKDTree</span>


<span class="k">def</span><span class="w"> </span><span class="nf">determine_nearest_river_cell</span><span class="p">(</span><span class="n">river_grid</span><span class="p">,</span> <span class="n">HRU_to_grid</span><span class="p">):</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="mi">15</span>
    <span class="n">valid_mask</span> <span class="o">=</span> <span class="n">river_grid</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">9999</span>

    <span class="n">valid_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">valid_mask</span><span class="p">)</span>
    <span class="n">valid_values</span> <span class="o">=</span> <span class="n">river_grid</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>

    <span class="n">above_threshold_mask</span> <span class="o">=</span> <span class="n">valid_values</span> <span class="o">&gt;</span> <span class="n">threshold</span>
    <span class="n">above_threshold_indices</span> <span class="o">=</span> <span class="n">valid_indices</span><span class="p">[</span><span class="n">above_threshold_mask</span><span class="p">]</span>
    <span class="n">above_threshold_indices_in_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">above_threshold_mask</span><span class="p">)</span>

    <span class="n">tree</span> <span class="o">=</span> <span class="n">cKDTree</span><span class="p">(</span><span class="n">above_threshold_indices</span><span class="p">)</span>
    <span class="n">distances</span><span class="p">,</span> <span class="n">indices_in_above</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">valid_indices</span><span class="p">)</span>

    <span class="n">nearest_indices_in_valid</span> <span class="o">=</span> <span class="n">above_threshold_indices_in_valid</span><span class="p">[</span><span class="n">indices_in_above</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">nearest_indices_in_valid</span><span class="p">[</span><span class="n">HRU_to_grid</span><span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">load_grid</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">return_transform_and_crs</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">filepath</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;.tif&quot;</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;tif files are now deprecated. Consider rebuilding the model.&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span> <span class="k">else</span> <span class="n">data</span>
            <span class="k">if</span> <span class="n">return_transform_and_crs</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">data</span>
    <span class="k">elif</span> <span class="n">filepath</span><span class="o">.</span><span class="n">suffixes</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;.zarr&quot;</span><span class="p">,</span> <span class="s2">&quot;.zip&quot;</span><span class="p">]:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">convenience</span><span class="o">.</span><span class="n">open_group</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][:]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span> <span class="k">else</span> <span class="n">data</span>
        <span class="k">if</span> <span class="n">return_transform_and_crs</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">x</span><span class="p">[:]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">y</span><span class="p">[:]</span>
            <span class="n">x_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">x</span><span class="p">[:])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">y_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">y</span><span class="p">[:])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">transform</span> <span class="o">=</span> <span class="n">Affine</span><span class="p">(</span>
                <span class="n">a</span><span class="o">=</span><span class="n">x_diff</span><span class="p">,</span>
                <span class="n">b</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">c</span><span class="o">=</span><span class="n">x</span><span class="p">[:][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_diff</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                <span class="n">d</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">e</span><span class="o">=</span><span class="n">y_diff</span><span class="p">,</span>
                <span class="n">f</span><span class="o">=</span><span class="n">ds</span><span class="o">.</span><span class="n">y</span><span class="p">[:][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_diff</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">wkt</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">spatial_ref</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;spatial_ref&quot;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">wkt</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;File format not supported.&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="to_grid">
<a class="viewcode-back" href="../../HRUs.html#geb.HRUs.to_grid">[docs]</a>
<span class="nd">@njit</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">to_grid</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">grid_to_HRU</span><span class="p">,</span> <span class="n">land_use_ratio</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="s2">&quot;weightedmean&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Numba helper function to convert from HRU to grid.</span>

<span class="sd">    Args:</span>
<span class="sd">        data: The grid data to be converted.</span>
<span class="sd">        grid_to_HRU: Array of size of the compressed grid cells. Each value maps to the index of the first unit of the next cell.</span>
<span class="sd">        land_use_ratio: Relative size of HRU to grid.</span>
<span class="sd">        fn: Name of function to apply to data. In most cases, several HRUs are combined into one grid unit, so a function must be applied. Choose from `mean`, `sum`, `nansum`, `max` and `min`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ouput_data: Data converted to HRUs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">output_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">grid_to_HRU</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">grid_to_HRU</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span>
        <span class="s2">&quot;First value of grid_to_HRU cannot be 0. This would mean that the first HRU is empty.&quot;</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="n">grid_to_HRU</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">land_use_ratio</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span>
        <span class="s2">&quot;The last value of grid_to_HRU must be equal to the size of land_use_ratio. Otherwise, the last HRU would not be used.&quot;</span>
    <span class="p">)</span>

    <span class="n">prev_index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">grid_to_HRU</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
        <span class="n">cell_index</span> <span class="o">=</span> <span class="n">grid_to_HRU</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">fn</span> <span class="o">==</span> <span class="s2">&quot;weightedmean&quot;</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">prev_index</span><span class="p">:</span><span class="n">cell_index</span><span class="p">]</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">land_use_ratio</span><span class="p">[</span><span class="n">prev_index</span><span class="p">:</span><span class="n">cell_index</span><span class="p">]</span>
            <span class="n">output_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">values</span> <span class="o">*</span> <span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">fn</span> <span class="o">==</span> <span class="s2">&quot;weightednanmean&quot;</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">prev_index</span><span class="p">:</span><span class="n">cell_index</span><span class="p">]</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">land_use_ratio</span><span class="p">[</span><span class="n">prev_index</span><span class="p">:</span><span class="n">cell_index</span><span class="p">]</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">values</span><span class="p">)]</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">values</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">values</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">output_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">output_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">values</span> <span class="o">*</span> <span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">fn</span> <span class="o">==</span> <span class="s2">&quot;sum&quot;</span><span class="p">:</span>
            <span class="n">output_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">prev_index</span><span class="p">:</span><span class="n">cell_index</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">fn</span> <span class="o">==</span> <span class="s2">&quot;nansum&quot;</span><span class="p">:</span>
            <span class="n">output_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">prev_index</span><span class="p">:</span><span class="n">cell_index</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">fn</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span>
            <span class="n">output_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">prev_index</span><span class="p">:</span><span class="n">cell_index</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">fn</span> <span class="o">==</span> <span class="s2">&quot;min&quot;</span><span class="p">:</span>
            <span class="n">output_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">prev_index</span><span class="p">:</span><span class="n">cell_index</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="n">prev_index</span> <span class="o">=</span> <span class="n">cell_index</span>
    <span class="k">return</span> <span class="n">output_data</span></div>



<div class="viewcode-block" id="to_HRU">
<a class="viewcode-back" href="../../HRUs.html#geb.HRUs.to_HRU">[docs]</a>
<span class="nd">@njit</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">to_HRU</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">grid_to_HRU</span><span class="p">,</span> <span class="n">land_use_ratio</span><span class="p">,</span> <span class="n">output_data</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Numba helper function to convert from grid to HRU.</span>

<span class="sd">    Args:</span>
<span class="sd">        data: The grid data to be converted.</span>
<span class="sd">        grid_to_HRU: Array of size of the compressed grid cells. Each value maps to the index of the first unit of the next cell.</span>
<span class="sd">        land_use_ratio: Relative size of HRU to grid.</span>
<span class="sd">        fn: Name of function to apply to data. None if data should be directly inserted into HRUs - generally used when units are irrespective of area. &#39;mean&#39; if data should first be corrected relative to the land use ratios - generally used when units are relative to area.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ouput_data: Data converted to HRUs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">grid_to_HRU</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">grid_to_HRU</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">land_use_ratio</span><span class="o">.</span><span class="n">size</span>
    <span class="k">assert</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">grid_to_HRU</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">prev_index</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">fn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">grid_to_HRU</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="n">cell_index</span> <span class="o">=</span> <span class="n">grid_to_HRU</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">output_data</span><span class="p">[</span><span class="n">prev_index</span><span class="p">:</span><span class="n">cell_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">prev_index</span> <span class="o">=</span> <span class="n">cell_index</span>
    <span class="k">elif</span> <span class="n">fn</span> <span class="o">==</span> <span class="s2">&quot;weightedsplit&quot;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">grid_to_HRU</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="n">cell_index</span> <span class="o">=</span> <span class="n">grid_to_HRU</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">cell_sizes</span> <span class="o">=</span> <span class="n">land_use_ratio</span><span class="p">[</span><span class="n">prev_index</span><span class="p">:</span><span class="n">cell_index</span><span class="p">]</span>
            <span class="n">output_data</span><span class="p">[</span><span class="n">prev_index</span><span class="p">:</span><span class="n">cell_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">cell_sizes</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="n">cell_sizes</span>
            <span class="n">prev_index</span> <span class="o">=</span> <span class="n">cell_index</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">return</span> <span class="n">output_data</span></div>



<div class="viewcode-block" id="BaseVariables">
<a class="viewcode-back" href="../../HRUs.html#geb.HRUs.BaseVariables">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">BaseVariables</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This class has some basic functions that can be used for variables regardless of scale.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span>

<div class="viewcode-block" id="BaseVariables.plot">
<a class="viewcode-back" href="../../HRUs.html#geb.HRUs.BaseVariables.plot">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a simple plot for data.</span>

<span class="sd">        Args:</span>
<span class="sd">            data: Array to plot.</span>
<span class="sd">            ax: Optional matplotlib axis object. If given, data will be plotted on given axes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ax</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="BaseVariables.MtoM3">
<a class="viewcode-back" href="../../HRUs.html#geb.HRUs.BaseVariables.MtoM3">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">MtoM3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert array from meters to cubic meters.</span>

<span class="sd">        Args:</span>
<span class="sd">            array: Data in meters.</span>

<span class="sd">        Returns:</span>
<span class="sd">            array: Data in cubic meters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">array</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">cellArea</span></div>


<div class="viewcode-block" id="BaseVariables.M3toM">
<a class="viewcode-back" href="../../HRUs.html#geb.HRUs.BaseVariables.M3toM">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">M3toM</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert array from cubic meters to meters.</span>

<span class="sd">        Args:</span>
<span class="sd">            array: Data in cubic meters.</span>

<span class="sd">        Returns:</span>
<span class="sd">            array: Data in meters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">array</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">cellArea</span></div>


<div class="viewcode-block" id="BaseVariables.register_initial_data">
<a class="viewcode-back" href="../../HRUs.html#geb.HRUs.BaseVariables.register_initial_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">register_initial_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Register initial data.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">initial_conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="Grid">
<a class="viewcode-back" href="../../HRUs.html#geb.HRUs.Grid">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Grid</span><span class="p">(</span><span class="n">BaseVariables</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This class is to store data in the &#39;normal&#39; grid cells. This class works with compressed and uncompressed arrays. On initialization of the class, the mask of the study area is read from disk. This is the shape of any uncompressed array. Many values in this array, however, fall outside the stuy area as they are masked. Therefore, the array can be compressed by saving only the non-masked values.</span>

<span class="sd">    On initialization, as well as geotransformation and cell size are set, and the cell area is read from disk.</span>

<span class="sd">    Then, the mask is compressed by removing all masked cells, resulting in a compressed array.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">create_bucket</span><span class="p">(</span><span class="s2">&quot;data.grid.var&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scaling</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">mask</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="n">load_grid</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">][</span><span class="s2">&quot;areamaps/grid_mask&quot;</span><span class="p">],</span>
            <span class="n">return_transform_and_crs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">to_gdal</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">c</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">f</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">e</span> <span class="o">*</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">c</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">a</span> <span class="o">*</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">f</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">c</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">a</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">c</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">a</span> <span class="o">*</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">a</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
            <span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">f</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">e</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">f</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">e</span> <span class="o">*</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">e</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
            <span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="k">assert</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">e</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">a</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cell_area_uncompressed</span> <span class="o">=</span> <span class="n">load_grid</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">][</span><span class="s2">&quot;areamaps/cell_area&quot;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mask_flat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compressed_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_flat</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_flat</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">cellArea</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_area_uncompressed</span><span class="p">)</span>

        <span class="n">BaseVariables</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="Grid.full">
<a class="viewcode-back" href="../../HRUs.html#geb.HRUs.Grid.full">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">full</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a full array with size of mask. Takes any other argument normally used in np.full.</span>

<span class="sd">        Args:</span>
<span class="sd">            *args: Variable length argument list.</span>
<span class="sd">            **kwargs: Arbitrary keyword arguments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Grid.full_compressed">
<a class="viewcode-back" href="../../HRUs.html#geb.HRUs.Grid.full_compressed">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">full_compressed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a full array with size of compressed array. Takes any other argument normally used in np.full.</span>

<span class="sd">        Args:</span>
<span class="sd">            *args: Variable length argument list.</span>
<span class="sd">            **kwargs: Arbitrary keyword arguments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compressed_size</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Grid.compress">
<a class="viewcode-back" href="../../HRUs.html#geb.HRUs.Grid.compress">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">compress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compress array.</span>

<span class="sd">        Args:</span>
<span class="sd">            array: Uncompressed array.</span>

<span class="sd">        Returns:</span>
<span class="sd">            array: Compressed array.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">array</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span></div>


<div class="viewcode-block" id="Grid.decompress">
<a class="viewcode-back" href="../../HRUs.html#geb.HRUs.Grid.decompress">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">decompress</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">fillvalue</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ufunc</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decompress array.</span>

<span class="sd">        Args:</span>
<span class="sd">            array: Compressed array.</span>
<span class="sd">            fillvalue: Value to use for masked values.</span>

<span class="sd">        Returns:</span>
<span class="sd">            array: Decompressed array.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">fillvalue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">array</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">):</span>
                <span class="n">fillvalue</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fillvalue</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">outmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">fillvalue</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">array</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask_flat</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">output_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="n">array</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_flat</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_flat</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">outmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">outmap</span><span class="p">,</span> <span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">outmap</span><span class="o">.</span><span class="n">size</span><span class="p">))</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">output_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">*</span><span class="n">output_shape</span><span class="p">)</span>
        <span class="n">outmap</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">mask_flat</span><span class="p">]</span> <span class="o">=</span> <span class="n">array</span>
        <span class="k">return</span> <span class="n">outmap</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">output_shape</span><span class="p">)</span></div>


<div class="viewcode-block" id="Grid.plot">
<a class="viewcode-back" href="../../HRUs.html#geb.HRUs.Grid.plot">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot array.</span>

<span class="sd">        Args:</span>
<span class="sd">            array: Array to plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="Grid.plot_compressed">
<a class="viewcode-back" href="../../HRUs.html#geb.HRUs.Grid.plot_compressed">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_compressed</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">fillvalue</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ufunc</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot compressed array.</span>

<span class="sd">        Args:</span>
<span class="sd">            array: Compressed array to plot.</span>
<span class="sd">            fillvalue: Value to use for masked values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">fillvalue</span><span class="o">=</span><span class="n">fillvalue</span><span class="p">))</span></div>


<div class="viewcode-block" id="Grid.load">
<a class="viewcode-back" href="../../HRUs.html#geb.HRUs.Grid.load">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">compress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load array from disk.</span>

<span class="sd">        Args:</span>
<span class="sd">            filepath: Filepath of map.</span>
<span class="sd">            compress: Whether to compress array.</span>

<span class="sd">        Returns:</span>
<span class="sd">            array: Loaded array.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">load_grid</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="n">layer</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">compress</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">load_forcing_ds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">AsyncForcingReader</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s2">&quot;forcing&quot;</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;climate/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
            <span class="n">name</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="n">reader</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">reader</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">reader</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_forcing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reader</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">compress</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read_timestep</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">compress</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">hurs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;hurs_ds&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hurs_ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_forcing_ds</span><span class="p">(</span><span class="s2">&quot;hurs&quot;</span><span class="p">)</span>
        <span class="n">hurs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_forcing</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hurs_ds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">current_time</span><span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">hurs</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="n">hurs</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="s2">&quot;hurs out of range&quot;</span>
        <span class="k">return</span> <span class="n">hurs</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">pr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;pr_ds&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pr_ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_forcing_ds</span><span class="p">(</span><span class="s2">&quot;pr&quot;</span><span class="p">)</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_forcing</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pr_ds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">current_time</span><span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">pr</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="s2">&quot;Precipitation must be positive or zero&quot;</span>
        <span class="k">return</span> <span class="n">pr</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;ps_ds&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ps_ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_forcing_ds</span><span class="p">(</span><span class="s2">&quot;ps&quot;</span><span class="p">)</span>
        <span class="n">ps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_forcing</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ps_ds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">current_time</span><span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">ps</span> <span class="o">&gt;</span> <span class="mi">30_000</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ps</span> <span class="o">&lt;</span> <span class="mi">120_000</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="p">(</span>
            <span class="s2">&quot;ps out of range&quot;</span>
        <span class="p">)</span>  <span class="c1"># top of mount everest is 33700 Pa, highest pressure ever measures is 108180 Pa</span>
        <span class="k">return</span> <span class="n">ps</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">rlds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;rlds_ds&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rlds_ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_forcing_ds</span><span class="p">(</span><span class="s2">&quot;rlds&quot;</span><span class="p">)</span>
        <span class="n">rlds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_forcing</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rlds_ds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">current_time</span><span class="p">)</span>
        <span class="n">rlds</span> <span class="o">=</span> <span class="n">rlds</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">rlds</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="s2">&quot;rlds must be positive or zero&quot;</span>
        <span class="k">return</span> <span class="n">rlds</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">rsds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;rsds_ds&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rsds_ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_forcing_ds</span><span class="p">(</span><span class="s2">&quot;rsds&quot;</span><span class="p">)</span>
        <span class="n">rsds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_forcing</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rsds_ds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">current_time</span><span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">rsds</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="s2">&quot;rsds must be positive or zero&quot;</span>
        <span class="k">return</span> <span class="n">rsds</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">tas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;tas_ds&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tas_ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_forcing_ds</span><span class="p">(</span><span class="s2">&quot;tas&quot;</span><span class="p">)</span>
        <span class="n">tas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_forcing</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tas_ds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">current_time</span><span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">tas</span> <span class="o">&gt;</span> <span class="mi">170</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tas</span> <span class="o">&lt;</span> <span class="mi">370</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="s2">&quot;tas out of range&quot;</span>
        <span class="k">return</span> <span class="n">tas</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">tasmin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;tasmin_ds&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tasmin_ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_forcing_ds</span><span class="p">(</span><span class="s2">&quot;tasmin&quot;</span><span class="p">)</span>
        <span class="n">tasmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_forcing</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasmin_ds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">current_time</span><span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">tasmin</span> <span class="o">&gt;</span> <span class="mi">170</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tasmin</span> <span class="o">&lt;</span> <span class="mi">370</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="s2">&quot;tasmin out of range&quot;</span>
        <span class="k">return</span> <span class="n">tasmin</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">tasmax</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;tasmax_ds&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tasmax_ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_forcing_ds</span><span class="p">(</span><span class="s2">&quot;tasmax&quot;</span><span class="p">)</span>
        <span class="n">tasmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_forcing</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasmax_ds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">current_time</span><span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">tasmax</span> <span class="o">&gt;</span> <span class="mi">170</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tasmax</span> <span class="o">&lt;</span> <span class="mi">370</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="s2">&quot;tasmax out of range&quot;</span>
        <span class="k">return</span> <span class="n">tasmax</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">sfcWind</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;sfcWind_ds&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sfcWind_ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_forcing_ds</span><span class="p">(</span><span class="s2">&quot;sfcwind&quot;</span><span class="p">)</span>
        <span class="n">sfcWind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_forcing</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sfcWind_ds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">current_time</span><span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">sfcWind</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sfcWind</span> <span class="o">&lt;</span> <span class="mi">150</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="p">(</span>
            <span class="s2">&quot;sfcWind must be positive or zero. Highest wind speed ever measured is 113 m/s.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">sfcWind</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">spei_uncompressed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;spei_ds&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spei_ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_forcing_ds</span><span class="p">(</span><span class="s2">&quot;spei&quot;</span><span class="p">)</span>

        <span class="n">current_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">current_time</span>

        <span class="c1"># Determine the nearest first day of the month</span>
        <span class="k">if</span> <span class="n">current_time</span><span class="o">.</span><span class="n">day</span> <span class="o">&lt;=</span> <span class="mi">15</span><span class="p">:</span>
            <span class="n">spei_time</span> <span class="o">=</span> <span class="n">current_time</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Move to the first day of the next month</span>
            <span class="k">if</span> <span class="n">current_time</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">12</span><span class="p">:</span>
                <span class="n">spei_time</span> <span class="o">=</span> <span class="n">current_time</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                    <span class="n">year</span><span class="o">=</span><span class="n">current_time</span><span class="o">.</span><span class="n">year</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">1</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">spei_time</span> <span class="o">=</span> <span class="n">current_time</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="n">current_time</span><span class="o">.</span><span class="n">month</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">spei</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_forcing</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spei_ds</span><span class="p">,</span> <span class="n">spei_time</span><span class="p">,</span> <span class="n">compress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span>
            <span class="n">spei</span><span class="p">[</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>  <span class="c1"># Ensure no NaN values in non-masked cells</span>
        <span class="k">return</span> <span class="n">spei</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">spei</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;spei_ds&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spei_ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_forcing_ds</span><span class="p">(</span><span class="s2">&quot;spei&quot;</span><span class="p">)</span>
        <span class="n">spei</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_forcing</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spei_ds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">current_time</span><span class="p">)</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">spei</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">spei</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">gev_c</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">load_grid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">][</span><span class="s2">&quot;climate/gev_c&quot;</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">gev_loc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">load_grid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">][</span><span class="s2">&quot;climate/gev_loc&quot;</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">gev_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">load_grid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">][</span><span class="s2">&quot;climate/gev_scale&quot;</span><span class="p">])</span></div>



<div class="viewcode-block" id="HRUs">
<a class="viewcode-back" href="../../HRUs.html#geb.HRUs.HRUs">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">HRUs</span><span class="p">(</span><span class="n">BaseVariables</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This class forms the basis for the HRUs. To create the `HRUs`, each individual field owned by a farmer becomes a `HRU` first. Then, in addition, each other land use type becomes a separate HRU. `HRUs` never cross cell boundaries. This means that farmers whose fields are dispersed across multiple cells are simulated by multiple `HRUs`. Here, we assume that each `HRU`, is relatively homogeneous as it each `HRU` is operated by 1) a single farmer, or by a single other (i.e., non-farm) land-use type and 2) never crosses the boundary a hydrological model cell.</span>

<span class="sd">    On initalization, the mask of the study area for the cells are loaded first, and a mask on the maximum resolution of the HRUs is created. In this case, the maximum resolution of the HRUs is 20 times higher than the mask. Then the HRUs are actually created.</span>

<span class="sd">    Args:</span>
<span class="sd">        data: Data class for model.</span>
<span class="sd">        model: The GEB model.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>

        <span class="n">subgrid_mask</span> <span class="o">=</span> <span class="n">load_grid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s2">&quot;subgrid&quot;</span><span class="p">][</span><span class="s2">&quot;areamaps/sub_grid_mask&quot;</span><span class="p">])</span>
        <span class="n">submask_height</span><span class="p">,</span> <span class="n">submask_width</span> <span class="o">=</span> <span class="n">subgrid_mask</span><span class="o">.</span><span class="n">shape</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scaling</span> <span class="o">=</span> <span class="n">submask_height</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">submask_width</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaling</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">transform</span> <span class="o">*</span> <span class="n">Affine</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaling</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">to_gdal</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scaling</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scaling</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">cell_size</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaling</span>

        <span class="c1"># get lats and lons for subgrid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size</span> <span class="o">*</span> <span class="n">submask_width</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
            <span class="n">submask_width</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size</span> <span class="o">*</span> <span class="n">submask_height</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
            <span class="n">submask_height</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">BaseVariables</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">spinup</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spinup</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">spinup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">create_bucket</span><span class="p">(</span><span class="s2">&quot;data.HRU.var&quot;</span><span class="p">)</span>

        <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">land_use_type</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">land_use_ratio</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">land_owners</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">HRU_to_grid</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">grid_to_HRU</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">unmerged_HRU_indices</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_HRUs</span><span class="p">()</span>

        <span class="n">river_grid</span> <span class="o">=</span> <span class="n">load_grid</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">][</span><span class="s2">&quot;routing/kinematic/upstream_area&quot;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nearest_river_grid_cell</span> <span class="o">=</span> <span class="n">determine_nearest_river_cell</span><span class="p">(</span>
            <span class="n">river_grid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">HRU_to_grid</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">compressed_size</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Gets the compressed size of a full HRU array.</span>

<span class="sd">        Returns:</span>
<span class="sd">            compressed_size: Compressed size of HRU array.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">land_use_type</span><span class="o">.</span><span class="n">size</span>

<div class="viewcode-block" id="HRUs.create_HRUs_numba">
<a class="viewcode-back" href="../../HRUs.html#geb.HRUs.HRUs.create_HRUs_numba">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_HRUs_numba</span><span class="p">(</span>
        <span class="n">farms</span><span class="p">,</span> <span class="n">land_use_classes</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">scaling</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Numba helper function to create HRUs.</span>

<span class="sd">        Args:</span>
<span class="sd">            farms: Map of farms. Each unique integer is a unique farm. -1 is no farm.</span>
<span class="sd">            land_use_classes: CWatM land use class map [0-5].</span>
<span class="sd">            mask: Mask of the normal grid cells.</span>
<span class="sd">            scaling: Scaling between mask and maximum resolution of HRUs.</span>

<span class="sd">        Returns:</span>
<span class="sd">            land_use_array: Land use of each HRU.</span>
<span class="sd">            land_use_ratio: Relative size of HRU to grid.</span>
<span class="sd">            land_use_owner: Owner of HRU.</span>
<span class="sd">            HRU_to_grid: Maps HRUs to index of compressed cell index.</span>
<span class="sd">            var_to_HRU: Array of size of the compressed grid cells. Each value maps to the index of the first unit of the next cell.</span>
<span class="sd">            # var_to_HRU_uncompressed: Array of size of the grid cells. Each value maps to the index of the first unit of the next cell.</span>
<span class="sd">            unmerged_HRU_indices: The index of the HRU to the subcell.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">farms</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">mask</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">scaling</span> <span class="o">*</span> <span class="n">scaling</span>
        <span class="k">assert</span> <span class="n">farms</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">land_use_classes</span><span class="o">.</span><span class="n">size</span>
        <span class="n">ysize</span><span class="p">,</span> <span class="n">xsize</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span>

        <span class="n">n_nonmasked_cells</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="n">mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">grid_to_HRU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n_nonmasked_cells</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="c1"># var_to_HRU_uncompressed = np.full(mask.size, -1, dtype=np.int32)</span>
        <span class="n">HRU_to_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">farms</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">land_use_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">farms</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">land_use_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">farms</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">land_use_owner</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">farms</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">unmerged_HRU_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">farms</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

        <span class="n">HRU</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">var_cell_count_compressed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">var_cell_count_uncompressed</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ysize</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">xsize</span><span class="p">):</span>
                <span class="n">is_masked</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_masked</span><span class="p">:</span>
                    <span class="n">cell_farms</span> <span class="o">=</span> <span class="n">farms</span><span class="p">[</span>
                        <span class="n">y</span> <span class="o">*</span> <span class="n">scaling</span> <span class="p">:</span> <span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">scaling</span><span class="p">,</span> <span class="n">x</span> <span class="o">*</span> <span class="n">scaling</span> <span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">scaling</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>  <span class="c1"># find farms in cell</span>
                    <span class="n">cell_land_use_classes</span> <span class="o">=</span> <span class="n">land_use_classes</span><span class="p">[</span>
                        <span class="n">y</span> <span class="o">*</span> <span class="n">scaling</span> <span class="p">:</span> <span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">scaling</span><span class="p">,</span> <span class="n">x</span> <span class="o">*</span> <span class="n">scaling</span> <span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">scaling</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>  <span class="c1"># get land use classes for cells</span>
                    <span class="k">assert</span> <span class="p">(</span>
                        <span class="p">(</span><span class="n">cell_land_use_classes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="o">|</span> <span class="p">(</span><span class="n">cell_land_use_classes</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="o">|</span> <span class="p">(</span><span class="n">cell_land_use_classes</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
                        <span class="o">|</span> <span class="p">(</span><span class="n">cell_land_use_classes</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

                    <span class="n">sort_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">cell_farms</span><span class="p">)</span>
                    <span class="n">cell_farms_sorted</span> <span class="o">=</span> <span class="n">cell_farms</span><span class="p">[</span><span class="n">sort_idx</span><span class="p">]</span>
                    <span class="n">cell_land_use_classes_sorted</span> <span class="o">=</span> <span class="n">cell_land_use_classes</span><span class="p">[</span><span class="n">sort_idx</span><span class="p">]</span>

                    <span class="n">prev_farm</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># farm is never -1</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cell_farms_sorted</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                        <span class="n">farm</span> <span class="o">=</span> <span class="n">cell_farms_sorted</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">land_use</span> <span class="o">=</span> <span class="n">cell_land_use_classes_sorted</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">farm</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>  <span class="c1"># if area is not a farm</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">farm</span> <span class="o">!=</span> <span class="n">prev_farm</span><span class="p">:</span>
                            <span class="k">assert</span> <span class="n">land_use_array</span><span class="p">[</span><span class="n">HRU</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
                            <span class="k">assert</span> <span class="n">land_use</span> <span class="o">==</span> <span class="mi">1</span>  <span class="c1"># must be one because farm</span>
                            <span class="n">land_use_array</span><span class="p">[</span><span class="n">HRU</span><span class="p">]</span> <span class="o">=</span> <span class="n">land_use</span>
                            <span class="k">assert</span> <span class="n">land_use_size</span><span class="p">[</span><span class="n">HRU</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
                            <span class="n">land_use_size</span><span class="p">[</span><span class="n">HRU</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="n">land_use_owner</span><span class="p">[</span><span class="n">HRU</span><span class="p">]</span> <span class="o">=</span> <span class="n">farm</span>

                            <span class="n">HRU_to_grid</span><span class="p">[</span><span class="n">HRU</span><span class="p">]</span> <span class="o">=</span> <span class="n">var_cell_count_compressed</span>

                            <span class="n">prev_farm</span> <span class="o">=</span> <span class="n">farm</span>
                            <span class="n">HRU</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">land_use_size</span><span class="p">[</span><span class="n">HRU</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

                        <span class="n">unmerged_HRU_indices</span><span class="p">[</span>
                            <span class="n">y</span> <span class="o">*</span> <span class="n">scaling</span> <span class="o">+</span> <span class="n">sort_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">//</span> <span class="n">scaling</span><span class="p">,</span>
                            <span class="n">x</span> <span class="o">*</span> <span class="n">scaling</span> <span class="o">+</span> <span class="n">sort_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">%</span> <span class="n">scaling</span><span class="p">,</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="n">HRU</span> <span class="o">-</span> <span class="mi">1</span>

                    <span class="n">sort_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">cell_land_use_classes</span><span class="p">)</span>
                    <span class="n">cell_farms_sorted</span> <span class="o">=</span> <span class="n">cell_farms</span><span class="p">[</span><span class="n">sort_idx</span><span class="p">]</span>
                    <span class="n">cell_land_use_classes_sorted</span> <span class="o">=</span> <span class="n">cell_land_use_classes</span><span class="p">[</span><span class="n">sort_idx</span><span class="p">]</span>

                    <span class="n">prev_land_use</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="k">assert</span> <span class="n">prev_land_use</span> <span class="o">!=</span> <span class="n">cell_land_use_classes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cell_farms_sorted</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                        <span class="n">land_use</span> <span class="o">=</span> <span class="n">cell_land_use_classes_sorted</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">farm</span> <span class="o">=</span> <span class="n">cell_farms_sorted</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">farm</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">land_use</span> <span class="o">!=</span> <span class="n">prev_land_use</span><span class="p">:</span>
                            <span class="k">assert</span> <span class="n">land_use_array</span><span class="p">[</span><span class="n">HRU</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
                            <span class="n">land_use_array</span><span class="p">[</span><span class="n">HRU</span><span class="p">]</span> <span class="o">=</span> <span class="n">land_use</span>
                            <span class="k">assert</span> <span class="n">land_use_size</span><span class="p">[</span><span class="n">HRU</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
                            <span class="n">land_use_size</span><span class="p">[</span><span class="n">HRU</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="n">prev_land_use</span> <span class="o">=</span> <span class="n">land_use</span>

                            <span class="n">HRU_to_grid</span><span class="p">[</span><span class="n">HRU</span><span class="p">]</span> <span class="o">=</span> <span class="n">var_cell_count_compressed</span>

                            <span class="n">HRU</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">land_use_size</span><span class="p">[</span><span class="n">HRU</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

                        <span class="n">unmerged_HRU_indices</span><span class="p">[</span>
                            <span class="n">y</span> <span class="o">*</span> <span class="n">scaling</span> <span class="o">+</span> <span class="n">sort_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">//</span> <span class="n">scaling</span><span class="p">,</span>
                            <span class="n">x</span> <span class="o">*</span> <span class="n">scaling</span> <span class="o">+</span> <span class="n">sort_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">%</span> <span class="n">scaling</span><span class="p">,</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="n">HRU</span> <span class="o">-</span> <span class="mi">1</span>

                    <span class="n">grid_to_HRU</span><span class="p">[</span><span class="n">var_cell_count_compressed</span><span class="p">]</span> <span class="o">=</span> <span class="n">HRU</span>
                    <span class="n">var_cell_count_compressed</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">var_cell_count_uncompressed</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">land_use_size</span> <span class="o">=</span> <span class="n">land_use_size</span><span class="p">[:</span><span class="n">HRU</span><span class="p">]</span>
        <span class="n">land_use_array</span> <span class="o">=</span> <span class="n">land_use_array</span><span class="p">[:</span><span class="n">HRU</span><span class="p">]</span>
        <span class="n">land_use_owner</span> <span class="o">=</span> <span class="n">land_use_owner</span><span class="p">[:</span><span class="n">HRU</span><span class="p">]</span>
        <span class="n">HRU_to_grid</span> <span class="o">=</span> <span class="n">HRU_to_grid</span><span class="p">[:</span><span class="n">HRU</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">int</span><span class="p">(</span><span class="n">land_use_size</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span> <span class="o">==</span> <span class="n">n_nonmasked_cells</span> <span class="o">*</span> <span class="n">scaling</span> <span class="o">*</span> <span class="n">scaling</span>

        <span class="n">land_use_ratio</span> <span class="o">=</span> <span class="n">land_use_size</span> <span class="o">/</span> <span class="p">(</span><span class="n">scaling</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">land_use_array</span><span class="p">,</span>
            <span class="n">land_use_ratio</span><span class="p">,</span>
            <span class="n">land_use_owner</span><span class="p">,</span>
            <span class="n">HRU_to_grid</span><span class="p">,</span>
            <span class="n">grid_to_HRU</span><span class="p">,</span>
            <span class="n">unmerged_HRU_indices</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="HRUs.create_HRUs">
<a class="viewcode-back" href="../../HRUs.html#geb.HRUs.HRUs.create_HRUs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_HRUs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Function to create HRUs.</span>

<span class="sd">        Returns:</span>
<span class="sd">            land_use_array: Land use of each HRU.</span>
<span class="sd">            land_use_ratio: Relative size of HRU to grid.</span>
<span class="sd">            land_use_owner: Owner of HRU.</span>
<span class="sd">            HRU_to_grid: Maps HRUs to index of compressed cell index.</span>
<span class="sd">            grid_to_HRU: Array of size of the compressed grid cells. Each value maps to the index of the first unit of the next cell.</span>
<span class="sd">            unmerged_HRU_indices: The index of the HRU to the subcell.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">land_use_classes</span> <span class="o">=</span> <span class="n">load_grid</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s2">&quot;subgrid&quot;</span><span class="p">][</span><span class="s2">&quot;landsurface/land_use_classes&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_HRUs_numba</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">farms</span><span class="p">,</span> <span class="n">land_use_classes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaling</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="HRUs.zeros">
<a class="viewcode-back" href="../../HRUs.html#geb.HRUs.HRUs.zeros">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">zeros</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return an array (CuPy or Numpy) of zeros with given size. Takes any other argument normally used in np.zeros.</span>

<span class="sd">        Args:</span>
<span class="sd">            *args: Variable length argument list.</span>
<span class="sd">            **kwargs: Arbitrary keyword arguments.</span>

<span class="sd">        Returns:</span>
<span class="sd">            array: Array with size of number of HRUs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="HRUs.full_compressed">
<a class="viewcode-back" href="../../HRUs.html#geb.HRUs.HRUs.full_compressed">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">full_compressed</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">fill_value</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">gpu</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a full array with size of number of HRUs. Takes any other argument normally used in np.full.</span>

<span class="sd">        Args:</span>
<span class="sd">            *args: Variable length argument list.</span>
<span class="sd">            **kwargs: Arbitrary keyword arguments.</span>

<span class="sd">        Returns:</span>
<span class="sd">            array: Array with size of number of HRUs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compressed_size</span><span class="p">,</span> <span class="n">fill_value</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="HRUs.decompress">
<a class="viewcode-back" href="../../HRUs.html#geb.HRUs.HRUs.decompress">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">decompress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">HRU_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decompress HRU array.</span>

<span class="sd">        Args:</span>
<span class="sd">            HRU_array: HRU_array.</span>

<span class="sd">        Returns:</span>
<span class="sd">            outarray: Decompressed HRU_array.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">HRU_array</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">):</span>
            <span class="n">nanvalue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">HRU_array</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="n">nanvalue</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nanvalue</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">outarray</span> <span class="o">=</span> <span class="n">HRU_array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">unmerged_HRU_indices</span><span class="p">]</span>
        <span class="n">outarray</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">nanvalue</span>
        <span class="k">return</span> <span class="n">outarray</span></div>


    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">compress_numba</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">unmerged_HRU_indices</span><span class="p">,</span> <span class="n">outarray</span><span class="p">,</span> <span class="n">nodatavalue</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
        <span class="n">array</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">unmerged_HRU_indices</span> <span class="o">=</span> <span class="n">unmerged_HRU_indices</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;last&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="n">nodatavalue</span><span class="p">:</span>
                    <span class="n">HRU</span> <span class="o">=</span> <span class="n">unmerged_HRU_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">outarray</span><span class="p">[</span><span class="n">HRU</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
            <span class="n">array</span> <span class="o">=</span> <span class="n">array</span><span class="p">[</span><span class="n">unmerged_HRU_indices</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">unmerged_HRU_indices</span> <span class="o">=</span> <span class="n">unmerged_HRU_indices</span><span class="p">[</span><span class="n">unmerged_HRU_indices</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">outarray</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span>
                <span class="n">unmerged_HRU_indices</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">array</span>
            <span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">unmerged_HRU_indices</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Method not implemented&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outarray</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;last&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;last&quot;</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">),</span> <span class="s2">&quot;Only last and mean method are implemented&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:],</span> <span class="s2">&quot;Array must have same shape as mask&quot;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">):</span>
            <span class="n">fill_value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fill_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">output_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span>
            <span class="p">(</span><span class="o">*</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">land_use_ratio</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">array</span><span class="o">.</span><span class="n">dtype</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">array</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compress_numba</span><span class="p">(</span>
                <span class="n">array</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">unmerged_HRU_indices</span><span class="p">,</span>
                <span class="n">output_data</span><span class="p">,</span>
                <span class="n">nodatavalue</span><span class="o">=</span><span class="n">fill_value</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">array</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compress_numba</span><span class="p">(</span>
                    <span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">unmerged_HRU_indices</span><span class="p">,</span>
                    <span class="n">output_data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">nodatavalue</span><span class="o">=</span><span class="n">fill_value</span><span class="p">,</span>
                    <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="k">return</span> <span class="n">output_data</span>

<div class="viewcode-block" id="HRUs.plot">
<a class="viewcode-back" href="../../HRUs.html#geb.HRUs.HRUs.plot">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">HRU_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Function to plot HRU data.</span>

<span class="sd">        Args:</span>
<span class="sd">            HRU_array: Data to plot. Size must be equal to number of HRUs.</span>
<span class="sd">            ax: Optional matplotlib axis object. If given, data will be plotted on given axes.</span>
<span class="sd">            show: Boolean whether to show the plot or not.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

        <span class="k">assert</span> <span class="n">HRU_array</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">compressed_size</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">HRU_array</span><span class="p">),</span> <span class="n">resample</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">hurs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">hurs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">hurs</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">to_HRU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">hurs</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">pr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">pr</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">to_HRU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">pr</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ps</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">to_HRU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">ps</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">rlds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rlds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">rlds</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">to_HRU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">rlds</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">rsds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rsds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">rsds</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">to_HRU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">rsds</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">tas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">tas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">tas</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">to_HRU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">tas</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">tasmin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">tasmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">tasmin</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">to_HRU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">tasmin</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">tasmax</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">tasmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">tasmax</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">to_HRU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">tasmax</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">sfcWind</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sfcWind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">sfcWind</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">to_HRU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">sfcWind</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></div>



<div class="viewcode-block" id="Modflow">
<a class="viewcode-back" href="../../HRUs.html#geb.HRUs.Modflow">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Modflow</span><span class="p">(</span><span class="n">BaseVariables</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>

        <span class="n">BaseVariables</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>



<div class="viewcode-block" id="Data">
<a class="viewcode-back" href="../../HRUs.html#geb.HRUs.Data">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Data</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The base data class for the GEB model. This class contains the data for the normal grid, the HRUs, and has methods to convert between the grid and HRUs.</span>

<span class="sd">    Args:</span>
<span class="sd">        model: The GEB model.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">farms</span> <span class="o">=</span> <span class="n">load_grid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s2">&quot;subgrid&quot;</span><span class="p">][</span><span class="s2">&quot;agents/farmers/farms&quot;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">Grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span> <span class="o">=</span> <span class="n">HRUs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modflow</span> <span class="o">=</span> <span class="n">Modflow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">spinup</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spinup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_water_demand</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">spinup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">cellArea</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_HRU</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">cellArea</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="s2">&quot;weightedsplit&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_water_demand</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">domestic_water_consumption_ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s2">&quot;forcing&quot;</span><span class="p">][</span><span class="s2">&quot;water_demand/domestic_water_consumption&quot;</span><span class="p">],</span>
            <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;zarr&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">domestic_water_demand_ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s2">&quot;forcing&quot;</span><span class="p">][</span><span class="s2">&quot;water_demand/domestic_water_demand&quot;</span><span class="p">],</span>
            <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;zarr&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">industry_water_consumption_ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s2">&quot;forcing&quot;</span><span class="p">][</span><span class="s2">&quot;water_demand/industry_water_consumption&quot;</span><span class="p">],</span>
            <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;zarr&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">industry_water_demand_ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s2">&quot;forcing&quot;</span><span class="p">][</span><span class="s2">&quot;water_demand/industry_water_demand&quot;</span><span class="p">],</span>
            <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;zarr&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">livestock_water_consumption_ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s2">&quot;forcing&quot;</span><span class="p">][</span><span class="s2">&quot;water_demand/livestock_water_consumption&quot;</span><span class="p">],</span>
            <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;zarr&quot;</span><span class="p">,</span>
        <span class="p">)</span>

<div class="viewcode-block" id="Data.to_HRU">
<a class="viewcode-back" href="../../HRUs.html#geb.HRUs.Data.to_HRU">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_HRU</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Function to convert from grid to HRU (Hydrologic Response Units).</span>

<span class="sd">        This method is designed to transform spatial grid data into a format suitable for HRUs, which are used in to represent distinct areas with homogeneous land use, soil type, and management conditions.</span>

<span class="sd">        Args:</span>
<span class="sd">            data (array-like or None): The grid data to be converted. If this parameter is set, `varname` must not be provided. Data should be an array where each element corresponds to grid cell values.</span>
<span class="sd">            fn (str or None): The name of the function to apply to the data before assigning it to HRUs. If `None`, the data is used as is. This is usually the case for variables that are independent of area, like temperature or precipitation fluxes. If &#39;weightedsplit&#39;, the data will be adjusted according to the ratios of land use within each HRU. This is important when dealing with variables that are area-dependent like precipitation or runoff volumes.</span>

<span class="sd">        Returns:</span>
<span class="sd">            output_data (array-like): Data converted to HRUs format. The structure and the type of the output depend on the input and the transformation function.</span>

<span class="sd">        Example:</span>
<span class="sd">            Suppose we have an instance of a class with a grid property containing temperature data under the attribute name &#39;temperature&#39;. To convert this grid-based temperature data into HRU format, we would use:</span>

<span class="sd">            ```python</span>
<span class="sd">            temperature_HRU = instance.to_HRU(data=temperature, fn=None)</span>
<span class="sd">            ```</span>

<span class="sd">            This will fetch the temperature data from `instance.grid.temperature`, assigning the temperature to HRU within a grid cell. In other words, each HRU within a grid cell has the same temperature.</span>

<span class="sd">            Another example, where want to plant forest in all HRUs with grassland within an area specified by a boolean mask.</span>

<span class="sd">            ```python</span>
<span class="sd">            mask_HRU = instance.to_HRU(data=mask_grid, fn=None)</span>
<span class="sd">            mask_HRU[land_use_type == grass_land_use_type] = False  # set all non-grassland HRUs to False</span>
<span class="sd">            ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
        <span class="c1"># make data same size as grid, but with last dimension being size of HRU</span>
        <span class="n">output_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">land_use_ratio</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">to_HRU</span><span class="p">(</span>
                <span class="n">data</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">grid_to_HRU</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">land_use_ratio</span><span class="p">,</span>
                <span class="n">output_data</span><span class="o">=</span><span class="n">output_data</span><span class="p">,</span>
                <span class="n">fn</span><span class="o">=</span><span class="n">fn</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">to_HRU</span><span class="p">(</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">grid_to_HRU</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">land_use_ratio</span><span class="p">,</span>
                    <span class="n">output_data</span><span class="o">=</span><span class="n">output_data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">fn</span><span class="o">=</span><span class="n">fn</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="k">return</span> <span class="n">output_data</span></div>


<div class="viewcode-block" id="Data.to_grid">
<a class="viewcode-back" href="../../HRUs.html#geb.HRUs.Data.to_grid">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">HRU_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Function to convert from HRUs to grid.</span>

<span class="sd">        Args:</span>
<span class="sd">            HRU_data: The HRU data to be converted (if set, varname cannot be set).</span>
<span class="sd">            fn: Name of function to apply to data. In most cases, several HRUs are combined into one grid unit, so a function must be applied. Choose from `mean`, `sum`, `nansum`, `max` and `min`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ouput_data: Data converted to grid units.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">HRU_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">HRU_data</span><span class="p">,</span> <span class="nb">float</span>
        <span class="p">):</span>  <span class="c1"># check if data is simple float. Otherwise should be numpy array.</span>
            <span class="n">outdata</span> <span class="o">=</span> <span class="n">HRU_data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outdata</span> <span class="o">=</span> <span class="n">to_grid</span><span class="p">(</span>
                <span class="n">HRU_data</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">grid_to_HRU</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">land_use_ratio</span><span class="p">,</span>
                <span class="n">fn</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">outdata</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">split_HRU_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ratio</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">ratio</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">ratio</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ratio</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">ratio</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">ratio</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">a</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">ratio</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="k">if</span> <span class="n">ratio</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">a</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ratio</span><span class="p">)</span> <span class="o">*</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">a</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">grid_to_HRU_uncompressed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">grid_to_HRU</span><span class="p">,</span> <span class="n">fillvalue</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">HRU_indices</span><span class="p">):</span>
        <span class="n">HRU</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">unmerged_HRU_indices</span><span class="p">[</span><span class="n">HRU_indices</span><span class="p">]</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">HRU</span> <span class="o">==</span> <span class="n">HRU</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>  <span class="c1"># assert all indices belong to same HRU - so only works for single grid cell at this moment</span>
        <span class="n">HRU</span> <span class="o">=</span> <span class="n">HRU</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">HRU</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="n">all_HRU_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">unmerged_HRU_indices</span> <span class="o">==</span> <span class="n">HRU</span>
        <span class="p">)</span>  <span class="c1"># this could probably be speed up</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">all_HRU_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">HRU_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
        <span class="p">)</span>  <span class="c1"># ensure that not all indices are split off</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="n">HRU_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">/</span> <span class="n">all_HRU_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">unmerged_HRU_indices</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">unmerged_HRU_indices</span> <span class="o">&gt;</span> <span class="n">HRU</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">unmerged_HRU_indices</span><span class="p">[</span><span class="n">HRU_indices</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">HRU_to_grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_HRU_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">HRU_to_grid</span><span class="p">,</span> <span class="n">HRU</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">grid_to_HRU</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">HRU_to_grid</span><span class="p">[</span><span class="n">HRU</span><span class="p">]</span> <span class="p">:]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">land_owners</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_HRU_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">land_owners</span><span class="p">,</span> <span class="n">HRU</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">agents</span><span class="o">.</span><span class="n">farmers</span><span class="o">.</span><span class="n">update_field_indices</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">agents</span><span class="o">.</span><span class="n">farmers</span><span class="o">.</span><span class="n">field_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_HRU_data</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">agents</span><span class="o">.</span><span class="n">farmers</span><span class="o">.</span><span class="n">field_indices</span><span class="p">,</span> <span class="n">HRU</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">land_use_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_HRU_data</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">land_use_type</span><span class="p">,</span> <span class="n">HRU</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">land_use_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_HRU_data</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">land_use_ratio</span><span class="p">,</span> <span class="n">HRU</span><span class="p">,</span> <span class="n">ratio</span><span class="o">=</span><span class="n">ratio</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">cellArea</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_HRU_data</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">cellArea</span><span class="p">,</span> <span class="n">HRU</span><span class="p">,</span> <span class="n">ratio</span><span class="o">=</span><span class="n">ratio</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">crop_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_HRU_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">crop_map</span><span class="p">,</span> <span class="n">HRU</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">crop_age_days_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_HRU_data</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">crop_age_days_map</span><span class="p">,</span> <span class="n">HRU</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">crop_harvest_age_days</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_HRU_data</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">crop_harvest_age_days</span><span class="p">,</span> <span class="n">HRU</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">SnowCoverS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_HRU_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">SnowCoverS</span><span class="p">,</span> <span class="n">HRU</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">DeltaTSnow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_HRU_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">DeltaTSnow</span><span class="p">,</span> <span class="n">HRU</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">frost_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_HRU_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">frost_index</span><span class="p">,</span> <span class="n">HRU</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">percolationImp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_HRU_data</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">percolationImp</span><span class="p">,</span> <span class="n">HRU</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">cropGroupNumber</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_HRU_data</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">cropGroupNumber</span><span class="p">,</span> <span class="n">HRU</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">capriseindex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_HRU_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">capriseindex</span><span class="p">,</span> <span class="n">HRU</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">actual_bare_soil_evaporation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_HRU_data</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">actual_bare_soil_evaporation</span><span class="p">,</span> <span class="n">HRU</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">KSat1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_HRU_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">KSat1</span><span class="p">,</span> <span class="n">HRU</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">KSat2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_HRU_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">KSat2</span><span class="p">,</span> <span class="n">HRU</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">KSat3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_HRU_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">KSat3</span><span class="p">,</span> <span class="n">HRU</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lambda1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_HRU_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lambda1</span><span class="p">,</span> <span class="n">HRU</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lambda2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_HRU_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lambda2</span><span class="p">,</span> <span class="n">HRU</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lambda3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_HRU_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lambda3</span><span class="p">,</span> <span class="n">HRU</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwp1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_HRU_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwp1</span><span class="p">,</span> <span class="n">HRU</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwp2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_HRU_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwp2</span><span class="p">,</span> <span class="n">HRU</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwp3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_HRU_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwp3</span><span class="p">,</span> <span class="n">HRU</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">ws1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_HRU_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">ws1</span><span class="p">,</span> <span class="n">HRU</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">ws2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_HRU_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">ws2</span><span class="p">,</span> <span class="n">HRU</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">ws3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_HRU_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">ws3</span><span class="p">,</span> <span class="n">HRU</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wres1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_HRU_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wres1</span><span class="p">,</span> <span class="n">HRU</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wres2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_HRU_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wres2</span><span class="p">,</span> <span class="n">HRU</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wres3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_HRU_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wres3</span><span class="p">,</span> <span class="n">HRU</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wfc1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_HRU_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wfc1</span><span class="p">,</span> <span class="n">HRU</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wfc2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_HRU_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wfc2</span><span class="p">,</span> <span class="n">HRU</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wfc3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_HRU_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wfc3</span><span class="p">,</span> <span class="n">HRU</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">kunSatFC12</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_HRU_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">kunSatFC12</span><span class="p">,</span> <span class="n">HRU</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">kunSatFC23</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_HRU_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">kunSatFC23</span><span class="p">,</span> <span class="n">HRU</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">arnoBeta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_HRU_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">arnoBeta</span><span class="p">,</span> <span class="n">HRU</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">w1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_HRU_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">w1</span><span class="p">,</span> <span class="n">HRU</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">w2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_HRU_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">w2</span><span class="p">,</span> <span class="n">HRU</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">w3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_HRU_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">w3</span><span class="p">,</span> <span class="n">HRU</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">topwater</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_HRU_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">topwater</span><span class="p">,</span> <span class="n">HRU</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">totAvlWater</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_HRU_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">totAvlWater</span><span class="p">,</span> <span class="n">HRU</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">minInterceptCap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_HRU_data</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">minInterceptCap</span><span class="p">,</span> <span class="n">HRU</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">interceptStor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_HRU_data</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">interceptStor</span><span class="p">,</span> <span class="n">HRU</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">potential_evapotranspiration_crop_life</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_HRU_data</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">potential_evapotranspiration_crop_life</span><span class="p">,</span> <span class="n">HRU</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">actual_evapotranspiration_crop_life</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_HRU_data</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">HRU</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">actual_evapotranspiration_crop_life</span><span class="p">,</span> <span class="n">HRU</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">HRU</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; <a href="../../copyright.html">Copyright</a> 2023, VU-IVM and IIASA.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>